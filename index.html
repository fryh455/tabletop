<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Tabletop Multiplayer</title>
<style>
html, body { margin:0; padding:0; height:100%; background:#111; color:white; font-family:sans-serif; overflow:hidden; }
#viewport { width:100%; height:100%; overflow:hidden; cursor:grab; position:relative; }
#world { position:absolute; transform-origin:0 0; }
#map { width:2000px; height:2000px; background: url('https://picsum.photos/2000/2000') center/cover no-repeat; position:absolute; top:0; left:0; }
.token { width:50px; height:50px; border-radius:50%; position:absolute; cursor:pointer; user-select:none; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:bold; }
.token.movable:hover { box-shadow:0 0 10px white; }
#sheet { position:fixed; bottom:10px; left:10px; background:#222; padding:10px; border:1px solid #555; display:none; z-index:1000; width:250px; }
#ui { position:fixed; top:10px; right:10px; z-index:1000; }
#ui button { margin-bottom:5px; padding:8px 12px; cursor:pointer; }
</style>
</head>
<body>

<div id="ui">
  <button id="createToken">Criar Token</button>
</div>

<div id="sheet"></div>

<div id="viewport">
  <div id="world">
    <div id="map"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* =========================
   CONFIGURAÇÃO FIREBASE
========================= */
firebase.initializeApp({
  apiKey: "AIzaSyBjSCYNOngXOSQGBU7jMj1kgf7hunfMjyI",
  authDomain: "marionetes-do-destino.firebaseapp.com",
  databaseURL: "https://marionetes-do-destino-default-rtdb.firebaseio.com",
  projectId: "marionetes-do-destino"
});

const auth = firebase.auth();
const db = firebase.database();
const tokensRef = db.ref("tokens");
let currentUser = null;

/* =========================
   BLOQUEIO SE NÃO LOGADO
========================= */
auth.onAuthStateChanged(user=>{
  if(!user) location.href="login.html";
  else{
    currentUser = { uid:user.uid, email:user.email };
    db.ref("users/"+user.uid).once("value").then(snap=>{
      currentUser.role = snap.val()?.role || "player";
      console.log("Logado como", currentUser.role);
      // refresh tokens highlights
      Object.keys(tokenElements).forEach(id=> refreshTokenMovableClass(id));
    });
  }
});

/* =========================
   ESTADO DO MAPA
========================= */
const viewport = document.getElementById("viewport");
const world = document.getElementById("world");
const sheet = document.getElementById("sheet");

let scale=1, offsetX=0, offsetY=0;
function updateTransform() { world.style.transform=`translate(${offsetX}px,${offsetY}px) scale(${scale})`; }

/* =========================
   DRAG MAP
========================= */
let draggingMap=false, startX, startY;
viewport.addEventListener("mousedown", e=>{
  if(e.target.classList.contains("token")) return;
  draggingMap=true;
  startX=e.clientX-offsetX; startY=e.clientY-offsetY;
  viewport.style.cursor="grabbing";
});
window.addEventListener("mouseup", ()=>{ draggingMap=false; viewport.style.cursor="grab"; });
window.addEventListener("mousemove", e=>{
  if(!draggingMap) return;
  offsetX=e.clientX-startX;
  offsetY=e.clientY-startY;
  updateTransform();
});

/* =========================
   ZOOM
========================= */
viewport.addEventListener("wheel", e=>{
  e.preventDefault();
  const delta = e.deltaY<0 ? 1.1 : 0.9;
  scale = Math.min(Math.max(scale*delta,0.3),3);
  updateTransform();
}, {passive:false});

/* =========================
   TOKENS
========================= */
const tokenElements = {};

function refreshTokenMovableClass(id){
  if(!currentUser) return;
  const el = tokenElements[id];
  const owner = el.dataset.owner;
  if(currentUser.role==="mestre" || currentUser.uid===owner) el.classList.add("movable");
  else el.classList.remove("movable");
}

function createTokenElement(id,data){
  let el = tokenElements[id];
  if(!el){
    el = document.createElement("div");
    el.className="token";
    el.id=id;
    el.dataset.owner = data.owner;
    el.textContent = data.label || "T";
    world.appendChild(el);
    tokenElements[id]=el;

    // DRAG TOKEN
    let dragging=false, dx,dy;
    el.addEventListener("mousedown", e=>{
      e.stopPropagation();
      if(!el.classList.contains("movable")) return;
      dragging=true; dx=e.offsetX; dy=e.offsetY;
    });
    window.addEventListener("mousemove", e=>{
      if(!dragging) return;
      const x=(e.clientX-offsetX)/scale - dx;
      const y=(e.clientY-offsetY)/scale - dy;
      el.style.left=x+"px";
      el.style.top=y+"px";
      tokensRef.child(id).update({x,y});
    });
    window.addEventListener("mouseup", ()=>dragging=false);

    // CLICK TOKEN -> SHOW SHEET
    el.addEventListener("click", e=>{
      e.stopPropagation();
      sheet.style.display="block";
      sheet.innerHTML = `
        <strong>Ficha Token</strong><br>
        ID: ${id}<br>
        Label: ${data.label || "T"}<br>
        X: ${Math.round(parseFloat(el.style.left))}<br>
        Y: ${Math.round(parseFloat(el.style.top))}<br>
        Dono: ${data.owner}
      `;
    });
  }
  el.dataset.owner = data.owner;
  el.textContent = data.label || "T";
  el.style.left=data.x+"px";
  el.style.top=data.y+"px";
  refreshTokenMovableClass(id);
}

/* =========================
   SINCRONIZAÇÃO FIREBASE
========================= */
tokensRef.on("value", snap=>{
  snap.forEach(child=>{
    createTokenElement(child.key, child.val());
  });
});

/* =========================
   CRIAR TOKEN
========================= */
document.getElementById("createToken").onclick=()=>{
  if(!currentUser) return alert("Ainda carregando login...");
  const id = "token_"+Date.now();
  tokensRef.child(id).set({
    x:300,
    y:300,
    owner:currentUser.uid,
    label: currentUser.role==="mestre" ? "M" : "P"
  });
};
</script>
</body>
</html>
