{
  "firestore": {
    "rules": "rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    function signedIn() { return request.auth != null; }\n    function isRoomMaster(roomId) {\n      return signedIn() &&\n        exists(/databases/$(database)/documents/rooms/$(roomId)/players/$(request.auth.uid)) &&\n        get(/databases/$(database)/documents/rooms/$(roomId)/players/$(request.auth.uid)).data.role == 'master';\n    }\n    function isRoomPlayer(roomId) {\n      return signedIn() &&\n        exists(/databases/$(database)/documents/rooms/$(roomId)/players/$(request.auth.uid));\n    }\n\n    match /rooms/{roomId} {\n      allow read: if isRoomPlayer(roomId);\n      // Apenas master escreve meta da sala\n      allow create: if signedIn();\n      allow update, delete: if isRoomMaster(roomId);\n\n      match /players/{uid} {\n        allow read: if isRoomPlayer(roomId);\n        // Player só escreve o próprio doc\n        allow create, update, delete: if signedIn() && request.auth.uid == uid;\n      }\n\n      match /characters/{charId} {\n        allow read: if isRoomPlayer(roomId);\n        allow create, update, delete: if isRoomMaster(roomId) || (signedIn() && request.resource.data.ownerUid == request.auth.uid);\n      }\n\n      match /tokens/{tokenId} {\n        allow read: if isRoomPlayer(roomId);\n        allow create, update, delete: if isRoomMaster(roomId);\n      }\n\n      match /rolls/{rollId} {\n        allow read: if isRoomPlayer(roomId);\n        allow create: if isRoomPlayer(roomId);\n        allow update, delete: if isRoomMaster(roomId);\n      }\n\n      match /intentions/{intentId} {\n        allow read: if isRoomPlayer(roomId);\n        allow create, update: if isRoomPlayer(roomId);\n        allow delete: if isRoomMaster(roomId);\n      }\n\n      match /logs/{logId} {\n        allow read: if isRoomPlayer(roomId);\n        allow create: if isRoomPlayer(roomId);\n        allow update, delete: if isRoomMaster(roomId);\n      }\n\n      match /images/{imageId} {\n        allow read: if isRoomPlayer(roomId);\n        allow create, update, delete: if isRoomMaster(roomId);\n      }\n    }\n\n    // rollRequests: permitido para players (se você usar)\n    match /rooms/{roomId}/rollRequests/{reqId} {\n      allow read: if isRoomPlayer(roomId);\n      allow create: if isRoomPlayer(roomId);\n      allow update, delete: if isRoomMaster(roomId);\n    }\n  }\n}\n"
  }
}
